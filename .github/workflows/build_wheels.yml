name: Build SpargeAttn Wheels

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install CUDA
        uses: Jimver/cuda-toolkit@v0.2.21
        id: cuda-toolkit
        with:
          cuda: '13.0.0'
          method: 'network'
          # Оставляем только нужные компоненты, чтобы ускорить сборку
          sub-packages: '["nvcc", "cudart", "nvrtc", "visual_studio_integration"]'

      - name: Install Build Dependencies
        run: |
          pip install --upgrade pip setuptools wheel
          pip install torch==2.10.0 --index-url https://download.pytorch.org/whl/cu130
          pip install triton

      - name: Build Wheel
        run: |
          # Автоматически находим путь к установленному CUDA
          export CUDA_HOME=${{ steps.cuda-toolkit.outputs.cuda-path }}
          export PATH=$CUDA_HOME/bin:$PATH
          export LD_LIBRARY_PATH=$CUDA_HOME/lib64:$LD_LIBRARY_PATH
          
          # Ограничим архитектуры под ваши карты (30/40 серия)
          export TORCH_CUDA_ARCH_LIST="8.0;8.6;8.9"
          
          python setup.py bdist_wheel

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spargeattn-wheel-py313-cuda13
          path: dist/*.whl
